---
layout:     post
title:      "浅谈营销中台抽奖系统"
subtitle:   "Marketing medium lottery system"
header-img: "img/in-post/2020.08/12/lottery-v1.png"
date:       2020-08-12
author:     "caojiele"
tags:
    - 抽奖
    - 数据库设计
    - 流程图
---

## 抽奖模型
1. 根据配置的`参与抽奖策略`判定用户是否有参与抽奖的权限
2. 预处理抽奖，即提供快速返回抽奖结果的`后门`
3. 根据奖品配置的`奖品筛选策略`，筛选奖品，返回可能中的`奖项`
4. 根据配置的`开奖策略`, 对该奖项进行逻辑判定，判定是否中奖
5. 如果未中奖，则判定是否存在`默认奖项`, 存在则判定中`默认奖项`
```
LotteryResult lottery(Subject subject) {
    LotteryResult result = LotteryResult.NO_AUTHORITY;
    if (this.permit(subject)) {             // 判定是否允许参与抽奖
        result = preLottery(subject);       // 预处理抽奖
        if (result == null) {               
            result = LotteryResult.FAILED;
            // 奖品筛选
            LotteryPrize prize = this.selectPrize(subject);
            if (prize != null) {
                // 奖项判定
                result = prize.prefer(subject);
            }
            // 默认奖逻辑
            if (!result.isSuccess() && this.defaultPrize() != null) {
                result = this.defaultPrize().prefer(subject);
            }
        }
    }
    return result;
}
```

![image](https://note.youdao.com/yws/api/personal/file/F7E6CFAE773D44528B0D0D7F608414C3?method=download&shareKey=811c4347c0b93719f5a4c94c7829fc88)

## 逻辑链
上文提及的各种策略，以及预处理抽奖，都是以内置一个逻辑链实现的。它是一个典型的责任链模式. 它将逻辑控制赋予每一个逻辑节点本身.
#### `参与抽奖策略`示例
![image](https://note.youdao.com/yws/api/personal/file/C31E386DE72E4CBEB30997934C00E569?method=download&shareKey=811c4347c0b93719f5a4c94c7829fc88)

## 数据库设计

**黑名单**
|序号|字段|说明|类型|主键|外键|非空|约束|详细注释|构建类型|
|---|---|---|---|---|---|---|---|---|---|---|
|1|	id|	id|	varchar(64)|	Y||	Y||			
|2|	phone|	phone|	varchar(255)|||Y|默认值:NULL|用户手机号码	
|3|	cause|	cause|	varchar(255)|||Y|默认值:NULL|原因	

**抽奖活动**
|序号|字段|说明|类型|主键|外键|非空|约束|详细注释|构建类型|
|---|---|---|---|---|---|---|---|---|---|---|
|1|	id|	id|	varchar(64)|Y||Y||	主键	
|2|	title|title|varchar(255)|||	Y|	默认值:NULL|抽奖页标题	
|3|	name|name|varchar(255)|||Y|	默认值:NULL|抽奖活动名称	
|4|	type|type|int(11)|||Y|默认值:NULL|奖励类型：0->普通；1->活动关联（可删除)
|5|	form|form|int(11)|||Y|默认值:NULL|抽奖形式：0->摇一摇；1->九宫格	
|6|	genre|genre|int(11)|||Y|默认值:NULL|抽奖类型：0->自主抽奖  1->平台抽奖	
|7|	description|description|varchar(255)|||Y|默认值:NULL|奖励说明	
|8|	start_date|start_date|datetime|||Y|默认值:NULL|开始时间	
|9|	end_date|end_date|datetime|||Y|	默认值:NULL|结束时间	
|10|perfect_activity|perfect_activity|int(11)|||Y|默认值:NULL|是否是100%中奖：0->不是；1->是	
|11|join_num|join_num|int(11)|||Y|默认值:NULL|活动已参数次数	
|12|join_people_num|join_people_num|int(11)|||Y|默认值:NULL|活动已参数人数	
|13|virtual_join_people_num|virtual_join_people_num|int(11)|||Y|默认值:NULL|活动虚拟参与人数	
|14|show_join_people_num|show_join_people_num|int(11)|||Y|默认值:NULL|是否展示参与人数 ：0->隐藏；1->展示	
|15|award_num|award_num|int(11)|||Y|默认值:NULL|中奖次数	
|16|award_people_num|award_people_num|int(11)|||Y|默认值:NULL|中奖人数	
|17|award_num_limit|award_num_limit|int(11)|||Y|默认值:NULL|中奖人数限制	
|18|join_people_total_limit|join_people_total_limit|int(11)|||Y|默认值:NULL|总参与人数限制标志：0不限制，1限制，2奖品抽完即结束	
|19|join_people_total_limit_num|join_people_total_limit_num|int(11)|||Y|默认值:NULL|总参与限制人数	
|20|status|status|int(11)|||Y|默认值:NULL|抽奖状态：0->未上线；1->已上线；2->已下线；3->手动结束	
|21|backdrop|backdrop|varchar(255)|||Y|默认值:NULL|活动主题背景图	
|22|back_color|back_color|varchar(255)|||Y|默认值:NULL|背景色值	
|23|pic_prize|pic_prize|varchar(255)|||Y|默认值:NULL|我的奖品图	
|24|begin_draw|begin_draw|varchar(255)|||Y|默认值:NULL|开始抽奖图	
|25|show_winning_list|show_winning_list|int(11)|||Y|默认值:NULL|0不展示，1单条展示，2平铺展示	
|26|permit_share|permit_share|int(11)|||Y|默认值:NULL|允许分享 0不允许，1允许	
|27|pic_rule|pic_rule|varchar(255)|||Y|默认值:NULL|抽奖规则图	
|28|miss_point_pic|miss_point_pic|varchar(255)|||Y|默认值:NULL|未中奖图片	
|29|miss_point_tips|miss_point_tips|varchar(255)|||Y|默认值:NULL|未中奖提示	
|30|one_person_is_repeat|one_person_is_repeat|int(11)|||Y|默认值:NULL|同奖品下是否能重复，0可以重复，1不能重复	
|31|one_person_lottery_number|	one_person_lottery_number|int(11)|||Y|默认值:NULL|平台抽奖每人中奖次数	
|32|show_lottery_number|show_lottery_number|int(11)|||Y|默认值:NULL|可抽次数得显示隐藏	
|33|show_label|show_label|varchar(255)|||Y|默认值:NULL|展示字段（拼接）	
|34|show_lottery_person|show_lottery_person|int(11)|||Y|默认值:NULL|可抽人数显示隐藏	
|35|data_sources|data_sources|varchar(64)|||Y|默认值:NULL|数据来源：1->SN号 2->手机号 3->手机号及验证码	
|36|all_label|all_label|varchar(255)|||Y|默认值:NULL|全部标签字段	
|37|auto_lottery_number|auto_lottery_number|int(11)|||Y|默认值:NULL|自主抽奖每人中奖次数 0->不限；1->限制每人	
|38|lottery_user_type|lottery_user_type|varchar(64)|||Y|默认值:NULL|平台抽奖用户类型	
|39|store_channel|store_channel|int(11)|||Y|默认值:NULL|店铺渠道：0->无渠道；1-> 用户平台；2->零售销售	
|40|share_image|share_image|varchar(255)|||Y|默认值:NULL|分享图片	
|41|share_tips|share_tips|varchar(255)|||Y|默认值:NULL|分享提示	
|42|share_people_num|share_people_num|int(11)|||Y|默认值:NULL|分享人数
|42|visit_people_num|visit_people_num|int(11)|||Y|默认值:NULL|访问人数
|42|red_pack_num|red_pack_num|decimal(10,2)|||Y|默认值:NULL|红包发放金额

**抽奖活动参与码表**
|序号|字段|说明|类型|主键|外键|非空|约束|详细注释|构建类型|
|---|---|---|---|---|---|---|---|---|---|---|
|1|id|id|varchar(64)|Y||Y||主键	
|2|join_code|join_code|varchar(255)|||Y|默认值:NULL|抽奖码	
|3|user_id|user_id|varchar(64)|||Y|默认值:NULL|用户ID	
|4|user_token|user_token|varchar(255)|||Y|默认值:NULL|用户登录凭证	
|5|user_source|user_source|varchar(255)|||Y|默认值:NULL|用户来源	
|6|user_remark|user_remark|varchar(255)|||Y|默认值:NULL|用户备注	
|7|activity_id|activity_id|varchar(64)|||Y|默认值:NULL|抽奖ID	
|8|source|source|varchar(255)|||Y|默认值:NULL|抽奖码来源	
|9|source_id|source_id|varchar(255)|||Y|默认值:NULL|来源ID	
|10|status|status|int(11)|||Y|默认值:NULL|抽奖状态：0->未使用；1->已使用

**活动参与策略** (一个活动可能有多个活动参与策略，能满足一个就能参加)
|序号|字段|说明|类型|主键|外键|非空|约束|详细注释|构建类型|
|---|---|---|---|---|---|---|---|---|---|---|
|1|id|id|varchar(64)|Y||Y||主键	
|2|activity_id|activity_id|varchar(64)|||Y||活动ID	
|3|user_group_type|user_group_type|int(11)|||Y||默认值:0|目标用户 0所有 1动态配置	
|4|user_group_value|user_group_value|varchar(1000)|||Y||默认值:NULL|用户分组ID	
|5|require_level|require_level|varchar(64)|||Y||默认值:NULL|需要等级, 逗号分隔，只要满足其中一个等级	
|6|require_integral|require_integral|int(11)|||Y||默认值:NULL|需要积分（消耗积分）	
|7|join_number|join_number|int(11)|||Y||默认值:NULL|允许参数次数	
|8|join_period|join_period|int(11)|||Y||默认值:NULL|参与周期 0：永久 1：日 2：周 3：月 4：年，配合join_number设置限制活动参与次数	
|9|award_number|award_number|int(11)|||Y||默认值:NULL|中奖次数限制	
|10|award_period|award_period|int(11)|||Y||默认值:NULL|中奖次数限制周期，同join_period	
|11|priority|priority|int(11)|||Y||默认值:NULL|策略优先级, 越小优先级越高

**活动链接表** 
|序号|字段|说明|类型|主键|外键|非空|约束|详细注释|构建类型|
|---|---|---|---|---|---|---|---|---|---|---|
|1|id|id|varchar(64)|Y||Y||主键	
|2|activity_id|activity_id|varchar(64)|||Y||活动ID	
|3|url|url|varchar(255)|||Y|默认值:NULL|地址	
|4|remark|remark|varchar(255)|||Y|默认值:NULL|备注	
|5|type|type|int(11)|||Y|默认值:NULL|活动类型 0链接 1二维码

**活动奖品池**
|序号|字段|说明|类型|主键|外键|非空|约束|详细注释|构建类型|
|---|---|---|---|---|---|---|---|---|---|---|
|1|id|id|varchar(64)|Y||Y||主键	
|2|activity_id|activity_id|varchar(64)|||Y|默认值:NULL|活动ID	
|3|type|type|int(11)|||Y|默认值:NULL|奖品类别：0->实物；1->积分；2->虚拟商品；3->红包；4->无中奖	
|4|name|name|varchar(255)|||Y|默认值:NULL|奖品名称	
|5|level|level|varchar(255)|||Y|默认值:NULL|奖品等级	
|6|image|image|varchar(255)|||Y|默认值:NULL|奖品图片	
|7|description|description|varchar(255)|||Y|默认值:NULL|奖品描述	
|8|award_total|award_total|bigint(20)|||Y|默认值:NULL|奖品总数	
|9|award_distribute|award_distribute|bigint(20)|||Y|默认值:NULL|奖品已发放数量	
|10|award_lock_total|award_lock_total|int(11)|||Y|默认值:NULL|奖品锁定数量	
|11|is_default|is_default|int(11)|||Y|默认值:NULL|是否是默认奖品	
|12|distribute_type|distribute_type|int(11)|||Y|默认值:NULL|兑奖方式：1->自营发放；2->第三方平台	
|13|redirect_url|redirect_url|varchar(255)|||Y|默认值:NULL|跳转路径	
|14|redirect_url_image|redirect_url_image|varchar(255)|||Y|默认值:NULL|跳转路径图片	
|15|sku_code|sku_code|varchar(255)|||Y|默认值:NULL|商品编码	
|16|integral|integral|int(11)|||Y|默认值:NULL|奖励积分值	
|17|money|money|decimal(10,2)|||Y|默认值:NULL|价值，单位分	
|18|warning_surplus|warning_surplus|int(11)|||Y|默认值:NULL|预警库存	
|19|warning_phone|warning_phone|varchar(255)|||Y|默认值:NULL|预警手机号	
|20|priority|priority|int(11)|||Y|默认值:NULL|优先级，值越低优先级越高	
|21|status|status|int(11)|||Y|默认值:NULL|奖品状态：0->禁用；1->启用	
|22|is_deleted|is_deleted|int(11)|||Y|默认值:NULL|删除状态	
|23|tenant_id|tenant_id|varchar(12)|||Y|默认值:NULL|租户号	
|24|position|position|varchar(64)|||Y|默认值:NULL|位置, 用于九宫格配置	
|25|virtual_type|virtual_type|int(11)|||Y|默认值:NULL|虚拟类型：1->电商优惠券；2->优惠码；3->虚拟金	
|26|promotion_code|promotion_code|varchar(255)|||Y|默认值:NULL|优惠码	
|27|distribute_channel|distribute_channel|int(11)|||Y|默认值:NULL|放渠道：1->公众号\n     * 发放渠道：1->公众号	
|28|award_tips|award_tips|varchar(255)|||Y|默认值:NULL|中奖提示	
|29|main_function_menu|main_function_menu|varchar(255)|||Y|默认值:NULL|主功能按钮	
|30|main_function_menu_url|main_function_menu_url|varchar(255)|||Y|默认值:NULL|主功能按钮跳转地址	
|31|assist_function_menu|assist_function_menu|int(11)|||Y|默认值:NULL|辅功能按钮：1->页面跳转；2->一键关注	
|32|assist_function_menu_name|assist_function_menu_name|varchar(64)|||Y|默认值:NULL|辅功能按钮名称	
|33|assist_function_menu_url|assist_function_menu_url|varchar(255)|||Y|默认值:NULL|辅功能按钮跳转地址	
|34|assist_function_menu_qrcode|assist_function_menu_qrcode|varchar(255)|||Y|默认值:NULL|辅功能按钮二维码	
|35|deadline|deadline|int(11)|||Y|默认值:NULL|兑奖期限：1->随活动期限；2->固定期限；3->固定时长	
|36|fixed_term_start_time|fixed_term_start_time|datetime|||Y|默认值:NULL|固定期限开始日期	
|37|fixed_term_end_time|fixed_term_end_time	datetime|||Y|默认值:NULL|固定期限结束日期	
|38|fixed_term_later_date|fixed_term_later_date|int(11)|||Y|默认值:NULL|固定时长领取后几天生效	
|39|fixed_term_date|fixed_term_date|int(11)|||Y|默认值:NULL|固定时长有效天数	
|40|draw_condition|draw_condition|varchar(64)|||Y|默认值:NULL|领取条件：1->身份实名认证；2->注册会员	
|41|app_id|app_id|varchar(64)|||Y|默认值:NULL|appId	
|42|redirect_type|redirect_type|int(11)|||Y|默认值:NULL|跳转类型：0->跳转路径，1->跳转路径图片

```
# 奖品筛选策略, 筛选出用户可能中奖的奖品
prize_match_strategy {
  `activity_id`: '活动ID',
  `prize_id`: '奖品ID',
  `match_rate`: '中奖几率',
  `user_group_type`: '目标用户 0 所有 1动态配置',
  `user_group_value`: '用户分组ID',
  `priority`: '优先级 越小优先级越高'
}

# 奖品开奖策略
prize_strategy {
  `activity_id`: '活动ID',
  `prize_id`: '奖品ID',
  `prize_rate`: '中奖几率',
  `prize_num`: '库存数',
  `prize_distribute_num`: '已分发奖品数量',
  `start_date`: '开始时间',
  `end_date`: '结束时间',
  `user_group_type`: '目标用户 0 所有 1动态配置',
  `user_group_value`: '用户分组ID',
  `priority`: '优先级 越小优先级越高',
}

# 中奖纪录
prize_record {
    user_id: "用户ID",
    prize_id: "奖品ID",
    activity_id: "活动ID",
    award_time: "开奖时间",
    send_time: "发奖时间",
    status: "状态"
}
```

#### 标签设计
```
动态标签原理：
    定位人群 -> 目标是否有标签, 即是否属于对应人群
    
人群元数据：
    用户数据源
    取值逻辑
    匹配逻辑
    目标值
    
举例：
    用户档案表  -> 数据源
    用户age字段 -> 取值逻辑
    大于50岁    -> 匹配逻辑 + 目标值
    
标签复用：
    
    
标签扩展：
    缩小范围：
        年龄 >或< xxx
        年龄>  xxx
    sn存在 = sn exists
    指定SN = sn exists + sn==xxx
```
## 平台抽奖流程设计
```
1. 取用户池总数(有标签的情况取当前标签用户池总数)，用来制作随机数。假如：10000。

2. 开始抽奖
    1. 随机数取序号, 987
    2. 根据该序号取数据库实体，并排除已中奖人
        # 去获取序号大于等于987且满足条件的第一个用户
        SELECT *
        FROM
        	t_lottery_activity_user_pool
        WHERE order_num >= #{order_num}
        and activity_id = #{activity_id}
        and attr_1 = #{attr_1}
        and user_id not in #{user_id_list}
        and user_token not in #{user_token_list} 
        order by order_num desc
        limit 1;
        
        # 当获取用户失败时，即序号正好是最大值，且该序号已中奖
        # 去获取序号小于等于987且满足条件的第一个用户
        SELECT *
        FROM
        	t_lottery_activity_user_pool
        WHERE order_num <= #{order_num}
        and activity_id = #{activity_id}
        and attr_1 = #{attr_1}
        and user_id not in #{user_id_list}
        and user_token not in #{user_token_list} 
        order by order_num asc
        limit 1;
    3. 将取到的用户缓存下来，用于规避重复中奖。

3. 抽多个人就重复二步骤   
```
## 平台抽奖流程实现
```
# 开始抽奖某个奖
int maxAwardNum                         # 当次活动每人最大中奖次数
int repeatAward                         # 同奖品是否能重复中奖 - 基于userId判定人是否重复

cacheUserCountMap = null;
if (maxAwardNum > 0):
    getPointNumMap = getAwardUser();
if (repeatAward == 0):
    getPrizePointList = getPrizePointUser();    # userId
    
for item in batch:                       # 多批次抽奖
    if maxAwardNum == 0 && repeatAward == 1:
        # 随机去获取基于批次的用户，并设定为中奖用户
        getPointUser(item, item.count)
    else:
        for i in range(item.count):    # 单批次抽多次
            disableUser = getDisableUser(cacheUserCountMap, maxAwardNum)
            user = getPointUserOne(disableUser, getPointArray)
            if repeatAward == 0:
                getPrizePointList.put(user.id)
            if (maxAwardNum > 0) {
                if (getPointNumMap.containsKey(user.getUserId())) {
                    getPointNumMap.put(user.getUserId(), getPointNumMap.get(user.getUserId()) + 1);
                } else {
                    getPointNumMap.put(user.getUserId(), 1);
                }
            }            
```

## 平台抽奖数据库设计
```
# 用户池
CREATE TABLE `t_lottery_activity_platform_user_pool` (
  `id` varchar(64) NOT NULL COMMENT '主键',
  `activity_id` varchar(64) DEFAULT NULL COMMENT '活动ID',
  `user_id` int(11) DEFAULT NULL COMMENT '用户ID',
  `user_token` varchar(255) NOT NULL COMMENT '用户凭证',
  `user_source` varchar(255) DEFAULT NULL COMMENT '用户来源',
  `attr_1` varchar(255) DEFAULT NULL COMMENT '属性1',
  `attr_2` varchar(255) DEFAULT NULL COMMENT '属性2',
  `attr_3` varchar(255) DEFAULT NULL COMMENT '属性3',
  `attr_4` varchar(255) DEFAULT NULL COMMENT '属性4',
  `attr_5` varchar(255) DEFAULT NULL COMMENT '属性5',
  `attr_6` varchar(255) DEFAULT NULL COMMENT '属性6',
  `attr_7` varchar(255) DEFAULT NULL COMMENT '属性7',
  `attr_8` varchar(255) DEFAULT NULL COMMENT '属性8',
  `attr_9` varchar(255) DEFAULT NULL COMMENT '属性8',
  `attr_10` varchar(255) DEFAULT NULL COMMENT '属性10',
  `order_num` int(11) DEFAULT NULL,
  `create_account` varchar(64) DEFAULT NULL,
  `create_org` varchar(64) DEFAULT NULL,
  `update_account` varchar(64) DEFAULT NULL,
  `status` int(11) DEFAULT NULL,
  `is_deleted` int(11) DEFAULT NULL,
  `create_time` datetime DEFAULT NULL,
  `update_time` datetime DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `idx_activity_attr1` (`activity_id`,`attr_1`(191)) USING BTREE,
  KEY `idx_activity_attr2` (`activity_id`,`attr_2`(191)) USING BTREE,
  KEY `idx_activity_attr3` (`activity_id`,`attr_3`(191)) USING BTREE,
  KEY `idx_activity_attr4` (`activity_id`,`attr_4`(191)) USING BTREE,
  KEY `idx_activity_attr5` (`activity_id`,`attr_5`(191)) USING BTREE,
  KEY `idx_activity_attr6` (`activity_id`,`attr_6`(191)) USING BTREE,
  KEY `idx_activity_attr7` (`activity_id`,`attr_7`(191)) USING BTREE,
  KEY `idx_activity_attr8` (`activity_id`,`attr_8`(191)) USING BTREE,
  KEY `idx_activity_attr9` (`activity_id`,`attr_9`(191)) USING BTREE,
  KEY `idx_activity_attr10` (`activity_id`,`attr_10`(191)) USING BTREE,
  KEY `idx_activity_order_num` (`activity_id`,`order_num`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='平台抽奖用户池表';

# 平台抽奖批次
CREATE TABLE `t_lottery_activity_platform_batch` (
  `id` varchar(64) NOT NULL COMMENT '主键',
  `activity_id` varchar(64) DEFAULT NULL COMMENT '活动ID',
  `prize_id` varchar(64) DEFAULT NULL COMMENT '奖品ID',
  `batch_code` varchar(255) DEFAULT NULL COMMENT '批次号',
  `award_total` int(11) DEFAULT NULL COMMENT '抽奖人数',
  `priority` int(11) DEFAULT NULL COMMENT '优先级',
  `attr_1` varchar(255) DEFAULT NULL COMMENT '属性1',
  `attr_2` varchar(255) DEFAULT NULL COMMENT '属性2',
  `attr_3` varchar(255) DEFAULT NULL COMMENT '属性3',
  `attr_4` varchar(255) DEFAULT NULL COMMENT '属性4',
  `attr_5` varchar(255) DEFAULT NULL COMMENT '属性5',
  `attr_6` varchar(255) DEFAULT NULL COMMENT '属性6',
  `attr_7` varchar(255) DEFAULT NULL COMMENT '属性7',
  `attr_8` varchar(255) DEFAULT NULL COMMENT '属性8',
  `attr_9` varchar(255) DEFAULT NULL COMMENT '属性8',
  `attr_10` varchar(255) DEFAULT NULL COMMENT '属性10',
  `create_account` varchar(64) DEFAULT NULL,
  `create_org` varchar(64) DEFAULT NULL,
  `update_account` varchar(64) DEFAULT NULL,
  `status` int(11) DEFAULT NULL,
  `is_deleted` int(11) DEFAULT NULL,
  `create_time` datetime DEFAULT NULL,
  `update_time` datetime DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='平台抽奖批次表';
```

**未完待续。。。**
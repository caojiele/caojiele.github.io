---
layout:     post
title:      "聊聊 Nginx 的反向代理"
subtitle:   " Nginx是一款自由的、开源的、高性能的HTTP服务器和反向代理服务器 "
date:       2019-04-03
author:     "caojiele"
header-img: "img/in-post/2019.04/03/post-bg-nginx.png"
tags:
    - Nginx
    - 分布式
    - 反向代理
    - 负载均衡
    - 慕课网手记
---

> 本文来自于我的[慕课网手记](https://www.imooc.com/u/4024769)：[聊聊 Nginx 的反向代理](https://www.imooc.com/article/285351)，转载请保留链接 ;)

## 背景

最近在优化服务基础设施这块，正好有时间写一下Nginx的体会。相信大家都听说过反向代理，一提到反向代理一定会想到Nginx。什么你没听过Nginx？那么你一定听说过Apache吧！Apache是世界使用排名第一的Web服务器软件。它可以运行在几乎所有广泛使用的计算机平台上，由于其跨平台和安全性被广泛使用，是最流行的Web服务器端软件之一。Apache的发展时期很长，而且是毫无争议的世界第一大服务器。它有着很多优点：稳定、开源、跨平台等等。它出现的时间太长了，它兴起的年代，互联网产业远远比不上现在。所以它被设计为一个重量级的。它不支持高并发的服务器。在Apache上运行数以万计的并发访问，会导致服务器消耗大量内存。操作系统对其进行进程或线程间的切换也消耗了大量的CPU资源，导致HTTP请求的平均响应速度降低。所以这些都决定了Apache不可能成为高性能WEB服务器，轻量级高并发服务器Nginx就应运而生了。

### 什么是Nginx

俄罗斯的工程师Igor Sysoev，他在为Rambler Media工作期间，使用C语言开发了Nginx。Nginx作为WEB服务器一直为Rambler Media提供出色而又稳定的服务。然后呢，Igor Sysoev将Nginx代码开源，并且赋予自由软件许可证。

由于：
* Nginx是一款自由的、开源的、高性能的HTTP服务器和反向代理服务器（这是个开源的时代啊~）
* Nginx是一个跨平台服务器，可以运行在Linux,Windows,FreeBSD,Solaris, AIX,Mac OS等操作系统上。
* 可以作为反向代理进行负载均衡的实现，带来的极大的稳定性。

Nginx这样做的目的主要是将数据的承载量分摊到多个服务器上进行执行，这只是在服务基础设施上提高性能的优化手段之一。从下面图就可以看出：

![某项目架构图](https://cdn.nlark.com/yuque/0/2019/png/338441/1564804030380-3132fb67-da63-45e3-806c-31e9f36409bf.png)


### 什么是反向代理？

看了网上很多篇文章，下面这段话是我个人觉得介绍的最清楚的。
反向代理（Reverse Proxy）方式是指以代理服务器来接受Internet上的连接请求，然后将请求转发给内部网络上的服务器；并将从服务器上得到的结果返回给Internet上请求连接的客户端，此时代理服务器对外就表现为一个服务器。
所以反向代理服务器是引用在服务端。决定哪台服务器提供服务。
那么我就模拟了一个基本的反向代理和负载均衡配置实现，下面是我的操作步骤：

#### 反向代理的模拟

首先创建多个 tomcat 服务器，我这里创建了三个：
![创建多个 tomcat 服务器](https://cdn.nlark.com/yuque/0/2019/png/338441/1564804136025-e78d443b-000f-4f79-b3a5-6d6fc7db2375.png)

然后修改每个 tomcat 运行在不同的端口号上，每个 server.xml配置文件需要修改三处端口：
![修改端口号](https://cdn.nlark.com/yuque/0/2019/png/338441/1564804176023-6d0fb3a1-af7e-4215-825d-b7c39a43976a.png)

分别在 8080，8081，8082 端口配置 8006，8081，8010 端口，分别进行启动测试，但是注意防火墙配置问题。测试结果如下：
![测试结果](https://cdn.nlark.com/yuque/0/2019/png/338441/1564804219061-a6a2ae92-c383-4986-880a-12b8ded7cbcf.png)

接着配置 nginx 的配置文件，进行反向代理：
![配置 nginx 参数](https://cdn.nlark.com/yuque/0/2019/png/338441/1564804259003-13052507-1418-4f80-988e-aa6f0b510e1e.png)

最后不断访问刚配置的 test.tomcats.com 域名，发现三台 tomcat 成功运行的页面都有出现，比例大致 1：1：1：
![配置完后运行结果](https://cdn.nlark.com/yuque/0/2019/png/338441/1564804263247-6aca979b-e75d-4a4a-abb0-989aaf497308.png)

恭喜你，配置成功了！

#### 配置负载均衡

其实很简单，就是在刚刚配置的 nginx 文件中 的 upstream tomcats 中的 server 后面添加一个 weight, 即可代表权重。权重越高，分派请求的数量就越多。默认权重是 1。
![配置负载均衡](https://cdn.nlark.com/yuque/0/2019/png/338441/1564804266343-33e4188b-920a-4f6f-820c-112ea4df2937.png)